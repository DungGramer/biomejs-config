name: Release

on:
  push:
    branches:
      - main
      - master

permissions:
  contents: write
  issues: write
  pull-requests: write
  id-token: write

jobs:
  release:
    name: Release package
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, '[skip ci]')"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Validate package
        run: pnpm run validate

      - name: Semantic Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          NPM_CONFIG_PROVENANCE: true
        run: npx semantic-release

  # Verify the release
  verify-release:
    name: Verify published package
    needs: release
    runs-on: ubuntu-latest
    if: success()

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Get released version
        id: version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Released version: $VERSION"

      - name: Wait for npm propagation
        run: sleep 60

      - name: Verify version exists on npm
        run: |
          EXPECTED_VERSION="${{ steps.version.outputs.version }}"
          PUBLISHED_VERSION=$(npm view @dunggramer/biomejs-config@$EXPECTED_VERSION version 2>/dev/null || echo "")

          if [ -z "$PUBLISHED_VERSION" ]; then
            echo "Error: Version $EXPECTED_VERSION not found on npm registry"
            echo "Available versions:"
            npm view @dunggramer/biomejs-config versions --json
            exit 1
          fi

          if [ "$PUBLISHED_VERSION" != "$EXPECTED_VERSION" ]; then
            echo "Error: Version mismatch"
            echo "Expected: $EXPECTED_VERSION"
            echo "Published: $PUBLISHED_VERSION"
            exit 1
          fi

          echo "✓ Version $EXPECTED_VERSION is published on npm"

      - name: Test installation of specific version
        run: |
          EXPECTED_VERSION="${{ steps.version.outputs.version }}"
          mkdir test-install
          cd test-install
          npm init -y

          echo "Installing @dunggramer/biomejs-config@$EXPECTED_VERSION"
          npm install @dunggramer/biomejs-config@$EXPECTED_VERSION

          INSTALLED_VERSION=$(node -p "require('./node_modules/@dunggramer/biomejs-config/package.json').version")

          if [ "$INSTALLED_VERSION" != "$EXPECTED_VERSION" ]; then
            echo "Error: Installed version mismatch"
            echo "Expected: $EXPECTED_VERSION"
            echo "Installed: $INSTALLED_VERSION"
            exit 1
          fi

          echo "✓ Successfully installed version $INSTALLED_VERSION"

          # Verify main file exists
          if [ ! -f "node_modules/@dunggramer/biomejs-config/biome.jsonc" ]; then
            echo "Error: Main file biome.jsonc not found in package"
            exit 1
          fi

          echo "✓ Package structure is correct"
